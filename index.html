<!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ТИПС2024 - Работа 1</title>
        <meta name="description" content="By Ovchinnikov A., Grebennikova E., Suchkov D.">
        <style>
            .scrollable::-webkit-scrollbar {
                width: 10px;
            }
            .scrollable::-webkit-scrollbar-track {
                background: rgb(166, 193, 166);
            }
            .scrollable::-webkit-scrollbar-thumb {
                background-color: green;
                border: 2px solid rgb(0, 75, 0);
            }
            body {
                padding: 0;
                margin: 0;
                background-color: #f4f4f9;
                font-family: 'Verdana', sans-serif;
                color: #333;
            }

            * {
                box-sizing: border-box;
                font-family: 'Arial';
            }

            p {
                margin: 0px;
            }

            form {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                padding-top: 3px;
                background-color: #fff;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            input[type="number"]:focus{
                outline: none;
                background-color: rgb(255, 255, 255);
            }

            .x0 {
                width: calc((99% - 400px)/2);
            }
            .c{
                width: calc((99% - 400px)/2);
            }
            .f {
                width: 400px;
            }

            h4 {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 30px;
                font-size: 20px;
            }

            sub{
                margin-top: 12px;
            }
            sup{
                margin-top: -16px;
            }
            .sub{
                margin-left: -8px;
            }

            .inputs {
                height: calc(100% - 30px);
                overflow-y: scroll;
            }

            .x0 input,
            .c input {
                border: 0;
                border-left: 1px solid black;
                text-align: center;
                height: 100%;
                background-color: rgb(208, 255, 162);
                font-size: 16px;
            }

            .input-block {
                width: 100%;
                display: flex;
                justify-content: space-between;
                border-top: 1px solid black;
                padding: 1px;
                background-color: rgb(220, 255, 220);
                color: black
            }

            .input-block label {
                width: 80%;
                font-size: 16px;
                padding: 3px;
                font-weight: 500;
            }

            .input-block input {
                width: 20%;
                text-align: center;
            }

            .x0 .input-block label,
            .x0 header .p-title {
                width: 60%;
            }

            .x0 header .p,
            .x0 input {
                width: 20%;
            }

            header.input-block {
                height: 30px;
                overflow-y: scroll;
            }

            .x0 header p {
                text-align: center;
                font-size: 18px;
            }

            .c header .p-title {
                width: 80%;
            }

            .c header .p {
                width: 20%;
            }

            .c header p {
                text-align: center;
                font-size: 20px;
            }

            header {
                background-color: #4CAF50;
                color: white;
                display: flex;
                height: 30px;
            }

            .f header .p-title {
                width: 100%;
                text-align: center;
                font-size: 20px;
            }

            .function {
                display: flex;
                align-items: center;
                border-top: 1px solid black;
                width: 100%;
                padding: 3px;
                background-color: rgb(220, 255, 220);
            }

            .function-block {
                display: flex;
                justify-content: space-evenly;
                padding: 1px;
                margin: 0 2px;
            }

            .function label {
                display: flex;
                align-items: center;
                flex-direction: row;
                width: 30px;
            }

            .f-title {
                width: 64px !important;
                height: 100%;
                font-size: 14px;
            }

            .function input {
                text-align: center;
                width: 50px;
                height: 30px;
                background-color: rgb(208, 255, 162);
                font-size: 16px;
                border: 1px solid black;
            }

            #result {
                display: none;
                background-color: rgba(0, 0, 0, 0.262);
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                align-items: center;
                justify-content: center;
            }

            .inner {
                width: 98vw;
                height: 98vh;
                background-color: white;
            }

            .inner-header {
                height: 30px;
                background-color: rgb(0, 45, 0);
                display: flex;
                justify-content: end;
            }

            #close {
                background-color: red;
                height: 30px;
                width: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 0;
                color: white;
                font-size: 20px;
            }
            #normalize {
                background-color: #4CAF50;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 0;
                color: white;
                font-size: 20px;
            }

            #normalize:hover {
                background-color: #45a049;
            }

            .graph {
                height: calc(98vh - 30px);
                width: 98vw;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
                overflow-y: scroll;
            }

            canvas {
                border: solid 1px black;
            }

            .inputs {
                display: flex;
                flex-direction: column;
            }

            .values {
                display: flex;
                height: 90vh;
                justify-content: space-between;
            }
            .values section {
                border: 2px solid green;
            }

            .manage {
                width: 100%;
                height: 6vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .count {
                background-color: #4CAF50;
                font-size: 1.5rem;
                color: white;
                border: none;
                cursor: pointer;
                width: 80%;
                height: 100%;
                margin-top: 10px;
                border: 3px solid #2f6931;
            }

            .save {
                background-color: #4CAF50;
                font-size: 1rem;
                color: white;
                border: none;
                cursor: pointer;
                width: 10%;
                height: 100%;
                margin-top: 10px;
                border: 3px solid #2f6931;
            }
            .load {
                background-color: #4CAF50;
                font-size: 1rem;
                color: white;
                border: none;
                cursor: pointer;
                width: 10%;
                height: 100%;
                margin-top: 10px;
                border: 3px solid #2f6931;
            }

            .count:hover, .save:hover,.load:hover {
                background-color: #45a049;
            }
            .inner-head{
                width: 100%;
                display: flex;
                margin-right: 10px;
            }
            .p-title, .p{
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .legend{
                padding:2px;
            }

            @media(max-width: 1024px){
                .values{
                    flex-direction: column;
                }
                .x0,.c,.f{
                    height: 33%;
                    width: 100%;
                }
                .count {
                    font-size: 1rem;
                }
                .load, .save{
                    font-size: 0.75rem;
                }
            }
            .plot-wrap{
                width: 75vw;
            }
        </style>
    </head>

    <body>
        <form id="main">
            <div class="values">
                <section class="x0">
                    <header>
                        <div class="inner-head">
                            <p class="p-title">Параметры</p>
                            <p class="p">Нач. зн.</p>
                            <p class="p">Ниж. гран.</p>
                        </div>
                    </header>

                    <div class="inputs scrollable">
                    </div>
                </section>

                <section class="c">
                    <header>
                        <div class="inner-head">
                        <p class="p-title">Константа</p>
                        <p class="p">Знач</p>
                    </div>
                    </header>

                    <div class="inputs scrollable">
                    </div>
                </section>

                <section class="f">
                    <header>
                        <div class="inner-head">
                            <p class="p-title">Полиномы</p>
                        </div>
                    </header>

                    <div class="inputs scrollable">
                    </div>
                </section>
            </div>

            <section class="manage">
                <button id="graphsBtn" class="count" type="button">Графики</button>
                <button id="solutionBtn" class="count" type="button">Найти решение</button>

                <button class="save" type="button" onclick="save()">Сохранить</button>
                <button class="load" type="button" onclick="load()">Загрузить</button>
            </section>
        </form>

        <section id="result">
            <div class="inner">
                <header class="inner-header">
                    <button type="button" id="close">X</button>
                </header>
                <div class="graph scrollable">
                    <div class="plot-wrap">
                            <canvas id="plot1"></canvas>
                            <canvas id="plot2"></canvas>
                            <canvas id="plot3"></canvas>
                            <canvas id="plot4"></canvas>
                            <canvas id="plot5"></canvas>
                            <canvas id="plot6"></canvas>
                            <canvas id="plot7"></canvas>
                            <canvas id="plot8"></canvas>
                    </div>
                    <canvas id="radar1"></canvas>
                    <canvas id="radar2"></canvas>
                    <canvas id="radar3"></canvas>
                    <canvas id="radar4"></canvas>
                    <canvas id="radar5"></canvas>
                    <canvas id="radar6"></canvas>
                    <div class="legend">
                    </div>
                </div>
            </div>
        </section>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const delta = 0.1 //дельта в двух местах, тк два скрипта, почему? я не знаю

            let isNormalized = false;
            let originalSolution = [];
            // Параметры
            const params = {
                "1": "среднегодовой % выпускников-бакалавров",
                "2": "среднегодовой % выпускников-магистров",
                "3": "текущий % выпускников-бакалавров, закончивших обучение в срок",
                "4": "текущий % выпускников-магистров, закончивших обучение в срок",
                "5": "доля цитирований",
                "6": "общее количество публикаций",
                "7": "текущий % доходов из внешних источников",
                "8": "текущее количество исследований в области искусств",
                "9": "текущее количество часто цитируемых публикаций",
                "10": "текущий % совместных с регионом исследовательских публикаций",
                "11": "среднегодовой % постдоков",
                "12": "текущий % совместных с промышленными предприятиями",
                "13": "текущий % доходов от сторонних организаций",
                "14": "текущее количество присужденных патентов",
                "15": "текущий % совместных с частными организациями патентов",
                "16": "текущее количество малых инновационных предприятий на 1 штатного академического сотрудника",
                "17": "текущий % исследовательских публикаций по патентам",
                "18": "% доходов от непрерывного профессионального развития",
                "19": "текущее количество программ на иностранных языках для бакалавров",
                "20": "текущее количество исследований в области искусств",
                "21": "среднегодовой % иностранных студентов",
                "22": "среднегодовой % студентов, участвующих в программах обмена",
                "23": "среднегодовой % студентов, участвующих в международных программах",
                "24": "среднегодовой % иностранных сотрудников",
                "25": "текущий % совместных международных публикаций",
                "26": "среднегодовой % иностранных выпускников-докторантов",
                "27": "среднегодовой % выпускников-бакалавров, работающих в регионе",
                "28": "среднегодовой % выпускников-магистров, работающих в регионе",
                "29": "среднегодовой % студентов, участвующих в программах обмена",
                "30": "текущий % совместных с регионом исследовательских публикаций",
                "31": "текущий % доходов из региональных источников",
            }

            const paramsDiv = document.querySelector("#main .values .x0 .inputs")
            const legendDiv = document.querySelector(".graph .legend")

            for(let key in params) {
                let randomValue1 = Math.round((Math.random() * (1 - delta) + delta) * 1000) / 1000;
                let maxForSecond = randomValue1 - delta;
                let randomValue2 = Math.round(Math.random() * maxForSecond * 1000) / 1000;

                paramsDiv.innerHTML += `
                    <div class="input-block">
                        <label for="X${key}">[X<sub>${key}</sub>] - ${params[key]}</label>
                        <input id="X${key}"
                               type="number"
                               step="0.001"
                               min="0"
                               max="1"
                               required
                               value="${randomValue1}">
                        <input id="X${key}max"
                               type="number"
                               step="0.001"
                               min="0"
                               max="1"
                               required
                               value="${randomValue2}">
                    </div>`;

                legendDiv.innerHTML += `<p>[X<sub>${key}</sub>] - ${params[key]}</p>`;
            }

            // Константы
            const consts = {
                "BPn": "% выпускников-бакалавров в начале периода",
                "BPk": "% выпускников-бакалавров в конце периода",
                "MPn": "% выпускников-магистров на начало расчетного периода",
                "MPk": "% выпускников-магистров на конец расчетного периода",
                "BV": "% выпускников-бакалавров в начале периода, закончивших обучение в срок",
                "BC": "% выпускников-бакалавров в конце периода, закончивших обучение в срок",
                "BZ": "среднегодовое число зачисленных бакалавров",
                "MV": "количество выпускников-магистров в начале периода, закончивших обучение в срок",
                "MC": "количество выпускников-магистров в конце периода, закончивших обучение в срок",
                "MZ": "среднегодовое число зачисленных магистров",
                "C": "общее количество цитирований",
                "P": "общее количество публикаций",
                "PT": "количество публикаций по техническим дисциплинам",
                "PI": "количество публикаций в области искусств",
                "PJ": "количество междисциплинарных исследований",
                "PD": "количество публикаций по патентам",
                "PS": "прочие публикации",
                "G": "исследовательские гранты от национальных и международных финансовых учреждений",
                "IG": "гранты от научно-исследовательских советов и исследовательских фондов",
                "NG": "гранты от благотворительных и других некоммерческих организаций",
                "F": "общий объем финансирования вуза",
                "An": "количество публикаций в области искусств на начало расчетного периода",
                "Ak": "количество публикаций в области искусств на конец расчетного периода",
                "Vn": "количество часто цитируемых публикаций на начало расчетного периода",
                "Vk": "количество часто цитируемых публикаций на конец расчетного периода",
                "IDPn": "количество междисциплинарных публикаций на начало расчетного периода",
                "IDPk": "количество междисциплинарных публикаций на конец расчетного периода",
                "DPn": "% постдоков на начало расчетного периода",
                "DPk": "% постдоков на конец расчетного периода",
                "IPn": "% иностранных студентов на начало расчетного периода",
                "IPk": "% иностранных студентов на конец расчетного периода",
                "IB": "доходы от научных исследований для промышленности и бизнеса",
                "IN": "доходы от научных исследований для частных фондов, благотворительных и других некоммерческих организаций",
                "IL": "доходы от лицензирования",
                "DS": "совместные с другими организациями патенты",
                "DV": "патенты, зарегистрированные вузом",
                "DP": "прочие патенты",
                "JDn": "количество патентов, ссылающихся на промышленные предприятия, на начало расчетного периода",
                "JDk": "количество публикаций, ссылающихся на промышленные предприятия, на конец расчетного периода",
                "INn": "количество малых инновационных предприятий на начало расчетного периода",
                "INk": "количество малых инновационных предприятий на конец расчетного периода",
                "NPP": "общее количество научно-педагогического персонала",
                "PPn": "количество публикаций по патентам на начало расчетного периода",
                "PPk": "количество публикаций по патентам на конец расчетного периода",
                "Dn": "общее кол-во доходов от непрерывного проф.развития",
                "D": "общее кол-во доходов",
                "PBn": "количество программ на иностранных языках для бакалавров на начало расчетного периода",
                "PBk": "количество программ на иностранных языках для бакалавров на конец расчетного периода",
                "PB": "общее количество программ на иностранных языках для бакалавров",
                "PMn": "количество публикаций в области искусств на начало расчетного периода",
                "PMk": "количество публикаций в области искусств на конец расчетного периода",
                "OPn": "% студентов, участвующих в программах обмена на начало расчетного периода",
                "OPk": "% студентов, участвующих в программах обмена на конец расчетного периода",
                "JPn": "% студентов, участвующих в международных программах на начало расчетного периода",
                "JPk": "% студентов, участвующих в международных программах на конец расчетного периода",
                "ISPn": "% иностранных сотрудников на начало расчетного периода",
                "ISPk": "% иностранных сотрудников на конец расчетного периода",
                "MIPn": "количество публикаций с одним и более иностранных соавторов на начало расчетного периода",
                "MIPk": "количество публикаций с одним и более иностранных соавторов на конец расчетного периода",
                "IIDPn": "% иностранных выпускников-докторантов на начало расчетного периода",
                "IIDPk": "% иностранных выпускников-докторантов на конец расчетного периода",
                "BRPn": "количество междисциплинарных публикаций на начало расчетного периода",
                "BRPk": "количество междисциплинарных публикаций на конец расчетного периода",
                "MRPn": "% выпускников-магистров, работающих в регионе на начало расчетного периода",
                "MRPk": "% выпускников-магистров, работающих в регионе на конец расчетного периода",
                "SRPn": "% студентов, участвующих в программах обмена на начало расчетного периода",
                "SRPk": "% студентов, участвующих в программах обмена на конец расчетного периода",
                "RPn": "количество публикаций с одним и более соавтором, географически расположенном в том же регионе, на начало расчетного периода",
                "RPk": "количество публикаций с одним и более соавтором, географически расположенном в том же регионе, на конец расчетного периода",
                "IR": "доходы от научных исследований для промышленности и бизнеса в регионе",
                "NR": "доходы от научных исследований для региональных частных источников",
            }

            const constsDiv = document.querySelector("#main .values .c .inputs")

           for(let key in consts) {
                main_key = key.replace(/[nk]/, '');
                sub_key = key.replace(main_key, '');

                // Рандомная константа от 0.45 до 0.55
                const randomConstValue = Math.round((0.45 + Math.random() * 0.1) * 1000) / 1000;

                constsDiv.innerHTML +=
                `<div class="input-block">
                    <label for="${key}">[${main_key}${sub_key ? `<sub>${sub_key}</sub>` : ''}] - ${consts[key]}</label>
                    <input id="${key}"
                           type="number"
                           step="0.001"
                           min="0"
                           max="1"
                           required
                           value="${randomConstValue}">
                </div>`;
            }
            // Полиномы
            const funcs = {
                "1": "3",
                "2": "19",
                "3": "21",
                "4": "22",
                "5": "23",
                "6": "27",
                "7": "29",
                "8": "4",
                "9": "20",
                "10": "22",
                "11": "23",
                "12": "28",
                "13": "29",
                "14": "19",
                "15": "20",
                "16": "5",
                "17": "8",
                "18": "6",
                "19": "10",
                "20": "11",
                "21": "12",
                "22": "17",
                "23": "25",
                "24": "30",
                "25": "14",
                "28": "15",
                "29": "16",
                "31": "26",
                "32": "21",
                "33": "26",
                "34": "30",
            }

            const funcsDiv = document.querySelector("#main .values .f .inputs")

            for(let key in funcs){
                funcsDiv.innerHTML +=
                `<div class="function">
                    <label class="f-title" for="F${key}-d">F<sub>${key}</sub>(X<sub>${funcs[key]}</sub>)=</label>
                    <div class="function-block">
                        <input id="F${key}-a" type="number" step="0.001" required value="0">
                        <label for="F${key}-a">X<sup>3</sup><sub class="sub">${funcs[key]}</sub>+</label>
                    </div>
                    <div class="function-block">
                        <input id="F${key}-b" type="number" step="0.001" required value="0">
                        <label for="F${key}-b">X<sup>2</sup><sub class="sub">${funcs[key]}</sub>+</label>
                    </div>
                    <div class="function-block">
                        <input id="F${key}-c" type="number" step="0.001" required value="1">
                        <label for="F${key}-c">X<sub>${funcs[key]}</sub>+</label>
                    </div>
                    <div class="function-block">
                        <input id="F${key}-d" type="number" step="0.001" required value="0">
                    </div>
                </div>`;
            }
        </script>
        <script>
            const getData = () => {
                const delta = 0.1
                const form = document.querySelector("#main");
                let data = {
                    'x0': {},
                    'c': {},
                    'f': {},
                    'norm': [],
                };

                let x0s = form.querySelectorAll(".x0 .input-block");
                for (let i = 0; i < x0s.length; i++) {
                    let key = `X${(i + 1)}`;
                    data.x0[key] = Number(x0s[i].querySelector(`#${key}`).value);
                    data.norm.push(Number(x0s[i].querySelector(`#${key}max`).value));
                }

                for (let i = 0; i < data.norm.length; i++) {
                    const xKey = `X${i + 1}`;
                    const requiredMax = data.x0[xKey] + delta;
                    if (data.norm[i] >= requiredMax) {
                        console.error(`Ошибка: norm[${i}] (${data.norm[i]}) >= x0.${xKey} (${data.x0[xKey]}) + delta (${delta})`);
                        return null;
                    }
                }

                let cs = form.querySelectorAll(".c .input-block");
                for (let i = 0; i < cs.length; i++) {
                    let key = cs[i].querySelector("input").id;
                    data.c[key] = Number(cs[i].querySelector("input").value);
                }

                let fs = form.querySelectorAll(".f .function");
                fs.forEach(elem => {
                    let frr = elem.querySelector("label").getAttribute("for");
                    let key = frr.substring(0, frr.length-2);
                    data.f[`${key}`] = {
                        a: Number(elem.querySelector(`#${key}-a`).value),
                        b: Number(elem.querySelector(`#${key}-b`).value),
                        c: Number(elem.querySelector(`#${key}-c`).value),
                        d: Number(elem.querySelector(`#${key}-d`).value)
                    };
                });

                return data;
            };

            const save = () => {
                // Собираем и сохраняем текущее состояние
                const state = {
                    data: getData(),
                    solutionCache: solutionCache
                };
                const dataStr = "data:text/json;charset=utf-8," 
                    + encodeURIComponent(JSON.stringify(state));
                const dlAnchorElem = document.createElement("a");
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", "IPST1-2024.json");
                dlAnchorElem.click();
            }

            const load = () => {
                const getFileElement = document.createElement("input");
                getFileElement.setAttribute("type", "file");
                getFileElement.click();
                getFileElement.onchange = (event) => {
                    return new Promise((resolve, reject) => {
                        const fileReader = new FileReader();
                        fileReader.onload = (e) => {
                            try {
                                resolve(JSON.parse(e.target.result));
                            } catch {
                                alert("Неверный формат файла");
                            }
                        }
                        fileReader.readAsText(event.target.files[0]);
                    }).then(state => {
                        const data = state.data;
                        // Восстанавливаем поля формы как раньше
                        let x0s = form.querySelectorAll(".x0 .input-block");
                        for (let i = 0; i < x0s.length; i++) {
                            let key = `X${(i + 1)}`;
                            x0s[i].querySelector(`#${key}`).value = data.x0[key];
                            x0s[i].querySelector(`#${key}max`).value = data.norm[i];
                        }
                        let cs = form.querySelectorAll(".c .input-block");
                        for (let i = 0; i < cs.length; i++) {
                            let key = cs[i].querySelector("input").id;
                            cs[i].querySelector("input").value = data.c[key];
                        }
                        let fs = form.querySelectorAll(".f .function");
                        fs.forEach(elem => {
                            let frr = elem.querySelector("label").getAttribute("for")
                            let key = frr.substring(0, frr.length-2);
                            elem.querySelector(`#${key}-a`).value = data.f[key].a;
                            elem.querySelector(`#${key}-b`).value = data.f[key].b;
                            elem.querySelector(`#${key}-c`).value = data.f[key].c;
                            elem.querySelector(`#${key}-d`).value = data.f[key].d;
                        });

                        // Восстанавливаем solutionCache и активируем графики
                        solutionCache = state.solutionCache;
                        if (solutionCache) graphsBtn.disabled = false;
                    }).catch(err => {
                        alert(err);
                    });
                }
            }
        </script>
        <script>
          const lineLabelsPlugin = {
                id: 'lineLabels',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();

                    // Собираем все позиции подписей
                    const labelPositions = [];

                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        if (meta.hidden) return;

                        const data = meta.data;
                        const middleIndex = Math.floor(data.length / 2);
                        const point = data[middleIndex];
                        const label = dataset.label;

                        // Рассчитываем позицию
                        const x = point.x;
                        const y = point.y - 15;

                        // Проверка на коллизии
                        const collision = labelPositions.some(pos =>
                            Math.abs(pos.x - x) < 60 && Math.abs(pos.y - y) < 20
                        );

                        if (!collision) {
                            labelPositions.push({x, y});

                            // Фон
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';

                            // Текст
                            ctx.font = '12px Arial';
                            ctx.fillStyle = 'black';
                            ctx.textAlign = 'center';

                            ctx.fillText(label.split('-')[0], x, y);
                        }
                    });

                    ctx.restore();
                }
            };

            // Зарегистрировать плагин
            Chart.register(lineLabelsPlugin);
            //Инициализация холстов для отрисовки графика и лепестковых диаграмм с применением Chart.js
            const plot1 = document.getElementById('plot1');
            const plot2 = document.getElementById('plot2');
            const plot3 = document.getElementById('plot3');
            const plot4 = document.getElementById('plot4');
            const plot5 = document.getElementById('plot5');
            const plot6 = document.getElementById('plot6');
            const plot7 = document.getElementById('plot7');
            const plot8 = document.getElementById('plot8');
            const radar1 = document.getElementById('radar1');
            const radar2 = document.getElementById('radar2');
            const radar3 = document.getElementById('radar3');
            const radar4 = document.getElementById('radar4');
            const radar5 = document.getElementById('radar5');
            const radar6 = document.getElementById('radar6');

            //основные элементы страницы
            const form = document.querySelector("#main");
            const resWin = document.getElementById('result');
            const resultDown = document.getElementById('close');

            //объект доступа к холстам с графиками и диаграммами
            let chartObjects = {
                'plot1': null,
                'plot2': null,
                'plot3': null,
                'plot4': null,
                'plot5': null,
                'plot6': null,
                'plot7': null,
                'plot8': null,
                't = 0': null,
                't = 0.2': null,
                't = 0.4': null,
                't = 0.6': null,
                't = 0.8': null,
                't = 1': null,
            }

            // Кэш для результатов расчёта
            let solutionCache = null;

            const solutionBtn = document.getElementById('solutionBtn');
            const graphsBtn   = document.getElementById('graphsBtn');

            // Пока данных нет — графики строить нельзя
            graphsBtn.disabled = true;
            
            function setPlaceholderCoeffs(coefMap) {
                for (const key in coefMap) {
                    const [a, b, c, d] = coefMap[key];
                    document.getElementById(`F${key}-a`).value = a;
                    document.getElementById(`F${key}-b`).value = b;
                    document.getElementById(`F${key}-c`).value = c;
                    document.getElementById(`F${key}-d`).value = d;
                }
                alert("Решение найдено");
            }

            // Только получаем данные с бэка и кладём их в solutionCache
            solutionBtn.addEventListener('click', async (e) => {
                e.preventDefault();

                const localData = getData();
                if (!localData) {
                    alert(`Ниж. гран. должна быть меньше Нач. зн. минимум на ${delta}`);
                    return;
                }

                try {
                    const resp = await fetch('/api/count', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json;charset=utf-8' },
                        body: JSON.stringify(localData)
                    });

                    if (resp.status === 400) {
                        const { error } = await resp.json();
                        alert(error);
                        return;
                    }

                    const { message, coefficients } = await resp.json();     // массив точек и массив коэффициентов полинома
 
                    setPlaceholderCoeffs(coefficients)

                    console.log("asd")
                    solutionCache = { points: message, norm: localData.norm };

                    console.log('Данные успешно получены', solutionCache);
                    graphsBtn.disabled = false;                // теперь можно рисовать
                } catch (err) {
                    console.error('Ошибка запроса /api/count:', err);
                }
            });

            // Строим графики из ранее сохранённых точек
            graphsBtn.addEventListener('click', () => {
                if (!solutionCache) return;

                const { points, norm } = solutionCache;

                creatrGraph(points);
                createRadar('t = 0',   radar1, points[0],  norm);
                createRadar('t = 0.2', radar2, points[4],  norm);
                createRadar('t = 0.4', radar3, points[8],  norm);
                createRadar('t = 0.6', radar4, points[12], norm);
                createRadar('t = 0.8', radar5, points[16], norm);
                createRadar('t = 1',   radar6, points[20], norm);

                resWin.style.display = 'flex';
            });

            //скрыть окно результатов при закрытии
            resultDown.onclick = () => {
                resWin.style.display = "none";
            }

            //отрисовка графиков изменения параметров xi(t) на основе объекта решений solution
            const creatrGraph = (solution) => {
                originalSolution = solution;
                const formData = getData();

               const normalizeData = (data) => {
                   const allValues = data.flat(2);

                    const globalMin = Math.min(...allValues);
                    const globalMax = Math.max(...allValues);
                    const range = globalMax - globalMin;

                    return data.map(row =>
                        row.map(value => {
                            if (range === 0) return 0.5;
                            return (value - globalMin) / range;
                        })
                    );
                };

                console.log(normalizeData(solution), solution, isNormalized)
                const processedSolution = isNormalized ? normalizeData(solution) : solution;
                // Define parameter groups and their respective canvas IDs
                const groups = [
                    { start: 0, end: 3, canvasId: 'plot1', title: 'Parameters 1-4' },
                    { start: 4, end: 7, canvasId: 'plot2', title: 'Parameters 5-8' },
                    { start: 8, end: 11, canvasId: 'plot3', title: 'Parameters 9-12' },
                    { start: 12, end: 15, canvasId: 'plot4', title: 'Parameters 13-16' },
                    { start: 16, end: 19, canvasId: 'plot5', title: 'Parameters 17-20' },
                    { start: 20, end: 23, canvasId: 'plot6', title: 'Parameters 21-24' },
                    { start: 24, end: 27, canvasId: 'plot7', title: 'Parameters 25-28' },
                    { start: 28, end: 30, canvasId: 'plot8', title: 'Parameters 29-31' }
                ];

                groups.forEach(group => {
                    // Destroy existing chart if present
                    if (chartObjects[group.canvasId]) {
                        chartObjects[group.canvasId].destroy();
                    }

                    // Prepare data for the current group
                    const data = {
                        labels: [0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1],
                        datasets: []
                    };

                    // Populate datasets for each parameter in the group
                    for (let i = group.start; i <= group.end; i++) {
                        const values = [];
                        for (let j = 0; j < processedSolution.length; j++) {
                            values.push(processedSolution[j][i]);
                        }
                        data.datasets.push({
                            label: `X${i + 1} - ${params[i + 1]}`,
                            data: values,
                            fill: false,
                            borderColor: getColor(i - group.start),
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: getLineStyle(i - group.start)
                        });
                    }

                    // Create the chart
                    const ctx = document.getElementById(group.canvasId).getContext('2d');
                    chartObjects[group.canvasId] = new Chart(ctx, {
                        type: 'line',
                        responsive: true,
                        aspectRatio: 10,
                        data: data,
                        options: {
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'right',
                                    maxWidth: 1000,
                                    labels: {
                                        font: {
                                            size: 14
                                        },
                                        padding: 8,
                                    }
                                },
                                title: { display: true, text: group.title },
                                font: {
                                    size: 24
                                }
                            }
                        },
                        layout: {
                        padding: {
                            left: 20,
                            right: 20,
                            top: 20,
                            bottom: 20
                        }
                    }
                    });
                });
            };

            const formatFormula = (poly, paramIndex) => {
                let parts = [];
                if (poly.a !== 0) parts.push(`${poly.a}X<sup>3</sup><sub>${paramIndex}</sub>`);
                if (poly.b !== 0) parts.push(`${poly.b}X<sup>2</sup><sub>${paramIndex}</sub>`);
                if (poly.c !== 0) parts.push(`${poly.c}X<sub>${paramIndex}</sub>`);
                if (poly.d !== 0) parts.push(poly.d.toString());

                let formula = parts.join(' + ')
                    .replace(/\+\s-/g, ' - ')
                    .replace(/(\d+)\s+\+\s+(-?\d+)/g, '$1 $2');

                return formula || '0';
            };
            //отрисовка лепестковых диаграмм для заданного временного среза на основе:
            // имени диаграммы chartName в объекте chartObjects
            // элемента холста plot
            // значений на срезе solutionI
            // границах нормы norm
            const createRadar = (chartName, plot, solutionI, norm) => {

                //удаляем старую диаграмму
                chartObjects[chartName]?.destroy();

                //готовим шаблон для построения диаграммы
                let data = {
                    labels: ['X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'X8', 'X9', 'X10', 'X11', 'X12', 'X13', 'X14', 'X15', 'X16', 'X17', 'X18', 'X19', 'X20', 'X21', 'X22', 'X23', 'X24', 'X25', 'X26', 'X27', 'X28', 'X29', 'X30', 'X31'],
                    datasets: [
                        {
                            label: 'Значения параметров',
                            data: solutionI,
                            fill: false,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                        },
                        {
                            label: 'Границы нормы',
                            data: norm,
                            fill: true,
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderColor: 'rgb(255, 99, 132)',
                        },
                    ],
                }

                // Отрисовываем диаграмму
                chartObjects[chartName] = new Chart(plot, {
                    type: 'radar',
                    data: data,
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: 'Срез значений при ' + chartName,
                                font: {
                                    size: 24
                                }
                            }
                        }
                    }
                });
            }

            // Стилизация графиков
            const colors = ["red","orange","rgb(213, 216, 0)","rgb(7, 203, 0)","green","rgb(0, 207, 166)","blue","violet","purple","black","brown","gray"];

            function getColor(index) {
                const colors = ["red","blue","green","orange"];
                return colors[index % colors.length];
            }

            function getLineStyle(index) {
                if (index <= colors.length - 1) return [];
                if (index <= 2 * colors.length - 1) return [5, 2];
                return [20, 5, 20, 5];
            }

            // Добавить функцию переключения нормализации
            const toggleNormalization = () => {
                isNormalized = !isNormalized;
                document.querySelector('#normalize').textContent =
                    isNormalized ? "Отключить нормализацию" : "Включить нормализацию";

                // Перерисовываем графики с текущими данными
                creatrGraph(originalSolution);
            };
        </script>
    </body>

    </html>